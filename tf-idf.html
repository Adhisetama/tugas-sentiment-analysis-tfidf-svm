<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TF-IDF Vectorizer</title>
</head>
<!-- <link rel="stylesheet" href="./css/reset.css"> -->
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 3px;
        border: 1px solid red;
    }
    table {
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid black;
      text-align: left;
    }

    /* custom CSS */
    #main-container {
        width: auto;
        padding: 50px;
        margin: 0;
    }
    #form-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr;
        /* border: 2px solid black; */
    }
    #vocabulary-container {
        display: grid;
        grid-template-columns: 3fr 1fr;
        grid-template-rows: 1fr 30px;
    }
    #add-data-container table tr td * {
        width: 100%;
    }
    #add-data-container > button {
        padding: 5px 10px;
    }

    #vectorize-document {
        grid-column: span 2;
    }

    /* #vector-container {
        display: grid;
        grid-template-rows: 1fr 1fr;
        grid-template-columns: auto auto ;
    } */

    #document-vector-container, #idf-vectorizer-container, #svm-container {
        display: flex;
        width: 100%;
        flex-wrap: wrap;
    }

</style>
<body>
    <div id="main-container">

        <h2>TF-IDF Vectorizer</h2>

        <div id="form-container">
            <div id="upload-csv-container">
                <h3>upload data</h3>
                <p>format: csv</p>
                <p>example:</p>
                <table style="width: 100%;">
                    <tr><th>document (string)</th><th>class (1 or -1)</th><td rowspan="4" style="font-family: monospace;">
                    document, class<br>
                    this is a sample document, 1<br>
                    this also a sample document, -1<br>
                    make sure the data is already preprocessed, 1<br>
                    string defined without a quotation mark, 1<br>
                    the csv file should look almost like this, -1
                    </td></tr>
                    <tr><td>"this is sample document"</td><td>1</td></tr>
                    <tr><td>"this also a sample document"</td><td>-1</td></tr>
                    <tr><td>...</td><td>...</td></tr>
                </table>
                <form action="">
                    <input type="file" id="csv" accept=".csv">
                </form>
            </div>
            <div id="add-data-container">
                <h3>or insert data manually</h3>
                <table style="width: 100%;">
                    <thead>
                        <tr><th>document</th><th>class</th><th></th></tr>
                    </thead>
                    <tbody id="add-data-table">
                        <tr>
                            <td><input type="text" placeholder="type sentence here"></td>
                            <td><input type="number" min="-1" max="1" step="2" value="1"></td>
                            <td><button>üóëÔ∏è</button></td>
                        </tr>
                    </tbody>
                </table>
                <button id="add-document">+</button>
                <button id="submit-document">Submit</button>
            </div>
        </div>

        <div id="vocabulary-container">
            <form id="term-count-container">
                <h3>Œ£ words</h3>
                <table>
                    <thead><tr><th>term</th><th>count</th><th>select as vocab</th></tr></thead>
                    <tbody id="bag-of-words">
                        <!-- <tr>
                            <td>bjir</td>
                            <td>10</td>
                            <td><input type="checkbox"></td>
                        </tr> -->
                    </tbody>
                </table>
            </form>
            <div id="term-container">
                <h3>define vocabulary:</h3>
                <p style="font-family: monospace;" id="terms"></p>
            </div>
            <button id="vectorize-document"><b>Vectorize Documents</b></button>
        </div>

        <div id="document-vector-container">
            <table style="flex: 2">
                <thead id="thead-vector">
                    <tr>
                        <th rowspan="2">document</th>
                        <th colspan="3">vector x<sub>i</sub></th>
                        <th rowspan="2">class y<sub>i</sub></th>
                    </tr>
                    <tr>
                        <th>tes</th>
                        <th>tes</th>
                        <th>tes</th>
                    </tr>
                </thead>
                <tbody id="tbody-vector">
                    <tr>
                        <td>bjir azka hijau ...</td>
                        <td>1</td>
                        <td>1</td>
                        <td>1</td>
                        <td>-1</td>
                    </tr>
                </tbody>
            </table>
            <div style="flex: 1">
                <h3>2D space representation</h3>
                <canvas id="vector-canvas"></canvas>
                <br>
                <form action="">
                    <label for="vector-x">sumbu-x</label>
                    <select name="vector-x" id="vector-x" value="0"></select>
                    <label for="vector-y">sumbu-y</label>
                    <select name="vector-y" id="vector-y" value="0"></select>
                </form>
            </div>
            <button style="width: 100%;" id="download-dataset-csv">Download datased as CSV</button>
        </div>
        <div id="idf-vectorizer-container">
            <table style="flex: 0;">
                <thead><tr><th>term</th><th>IDF</th></tr></thead>
                <tbody id="table-idf">
                    <tr><td>term1</td><td>idf1</td></tr>
                </tbody>
            </table>
            <div id="idf-vectorizer" style="flex: 1;">
                <h3>vectorize a document</h3>
                <textarea id="textarea-vectorizer" rows="3" style="width: 100%;"></textarea>
                <button id="bakso-bakar">convert to vector</button>
                <table style="display: block;">
                    <tr>
                        <th rowspan="2">vector</th>
                        <th colspan="2" id="balsem-geliga">feature (terms)</th>
                    </tr>
                    <tr id="rolled-oat">
                        <th>tes</th>
                        <th>tes</th>
                    </tr>
                    <tr id="bakso1"><th>TF</th><td>2.642</td><td>1.002</td></tr>
                    <tr id="bakso2"><th>TF-IDF</th><td>2.642</td><td>1.002</td></tr>
                </table>
            </div>
            <button style="width: 100%;" id="download-idf-json">Download IDF as JSON</button>
        </div>

        <div id="svm-container">
            <div id="svm-display">
                <canvas id="svm-canvas"></canvas>
                <br>
                <div>
                    <label for="svm-x">sumbu-x</label>
                    <select name="svm-x" id="svm-x" value="0"></select>
                    <label for="svm-y">sumbu-y</label>
                    <select name="svm-y" id="svm-y" value="0"></select>
                    <button name="optimize-smo" id="optimize-smo">optimize (SMO)</button>
                </div>
            </div>
            <div id="svm-metrics">
                
            </div>
        </div>

    </div>

    <!-- get documents -->
    <script>
        const Data = {
            documents: [],
            classes: [],
            vectors: []
        }

        // handle csv upload
        document.getElementById("csv").addEventListener('change', event => {
            Data.documents.length = 0
            Data.classes.length = 0
            const file = event.target.files[0]
            if (file) {
                const reader = new FileReader()
                reader.onload = e => {
                    const lines = e.target.result.split('\n')
                    for (const line of lines) {
                        let [document, classes] = line.split(',')
                        document = document.trim()
                        classes = parseInt(classes)
                        if (classes === -1 || classes === 1) {
                            Data.documents.push(document)
                            Data.classes.push(classes)
                            console.log("data parsed: ", [document, classes])
                        }
                    }
                    document.dispatchEvent(new Event('documentsHasBeenInserted'))
                }
                reader.readAsText(file)
            }
        })

        // handle insert data manually
        document.getElementById("add-document").addEventListener("click", event => {
            const tr = document.createElement("tr")
            tr.innerHTML =
            `   <td><input type="text" placeholder="type sentence here"></td>
                <td><input type="number" min="-1" max="1" step="2" value="1"></td>
                <td><button>üóëÔ∏è</button></td>`
            document.getElementById("add-data-table").appendChild(tr)
        })
        document.getElementById("submit-document").addEventListener("click", event => {
            Data.documents.length = 0
            Data.classes.length = 0
            document.querySelectorAll("#add-data-table tr").forEach((row, i) => {
                // if (i === 0) return
                Data.documents.push(row.children[0].firstChild.value.trim())
                Data.classes.push(row.children[1].firstChild.value)
            })
            document.dispatchEvent(new Event('documentsHasBeenInserted'))
        })


    </script>

    <!-- document has been inserted -->
    <script src="./modules/tf-idf.js"></script>
    <script>
        const Documents = []    // TFIDF_Documents[]
        const bagOfWords = {}   // Object{
                                //    word:string => count:int
                                //  }
        const vocabulary = []   // string[]

        // handle changes of page
        document.addEventListener('documentsHasBeenInserted', e => {

            // reset previous input
            Documents.length = 0
            vocabulary.length = 0
            for (const word in bagOfWords) delete bagOfWords[word]
            Data.documents.forEach(e => Documents.push(new TFIDF_Document(e.split(' '))))
            const tbody = document.getElementById("bag-of-words")
            const terms = document.getElementById("terms")
            tbody.innerHTML = ""
            terms.innerHTML = ""

            // hitung total kata muncul
            Documents.forEach(d => {
                for (const word in d.bagOfWords) {
                    if (bagOfWords.hasOwnProperty(word))
                        bagOfWords[word] += d.bagOfWords[word]
                    else
                        bagOfWords[word] = d.bagOfWords[word]
                }
            })

            // tampilkan di tabel, kalo di klik checkbox nanti tabel satunya berubah
            // (dah gausah dibaca, aku jg pusing baca ini)
            for (const word in bagOfWords) {
                const tr = document.createElement("tr")
                tr.innerHTML = `<td>${word}</td><td>${bagOfWords[word]}</td><td><input type="checkbox" name="${word}"></td>`
                tbody.appendChild(tr)
            }

            // listen untuk checkbox
            document.getElementById("term-count-container").addEventListener("change", event => {
                // scan semua checkbox, mana yg dicheck
                vocabulary.length = 0
                for (const element of event.currentTarget.elements) {
                    if (element.checked) {
                        vocabulary.push(element.name)
                    }
                }
                terms.innerText = JSON.stringify(vocabulary)
            })
        })

        // vectorize document
        const Vectorizer = new TFIDF_Vectorizer()
        document.getElementById("vectorize-document").addEventListener("click", event => {
            Vectorizer.trainDocuments.length = 0
            Vectorizer.insertTrainDocuments(...Documents)
            Vectorizer.setVocabulary(vocabulary)
            Vectorizer.calculateIDF()
            document.dispatchEvent(new Event("documentsHasBeenVectorized"))
        })

    
    </script>
    
    <!-- document has been vectorized -->
    <script src="./modules/canvas.js"></script>
    <script src="./modules/utils.js"></script>
    <script>
        document.addEventListener("documentsHasBeenVectorized", event => {
            // INISIASI TABEL
            // thead
            {
                const [sego, goreng] = document.getElementById("thead-vector").children
                sego.children[1].setAttribute("colspan", `${Vectorizer.vocabulary.length}`)
                goreng.innerHTML = ""
                Vectorizer.vocabulary.forEach(term => {
                    const th = document.createElement("th")
                    th.innerText = `"${term}"`
                    goreng.appendChild(th)
                })
            }
            // tbody
            {
                const tbody = document.getElementById("tbody-vector")
                tbody.innerHTML = ""
                let i = 0
                for (const d of Vectorizer.trainDocuments) {
                    const docString = d.words.join(" ")
                    const docVector = Vectorizer.vectorizeDocument(d)
                    Data.vectors.push(docVector)
                    const tr = document.createElement("tr")
                    // note: vv print document as string tp batasin sampe 25 huruf
                    let tr_innerHTML = `<td${docString.length > 25 ? ` title="${docString}">"${docString.substring(0, 25)}..."` : `>"${docString}"`}</td>`
                    docVector.forEach(x => tr_innerHTML += `<td>${x.toFixed(7)}</td>`)
                    tr_innerHTML += `<td>${Data.classes[i]}</td>`
                    tr.innerHTML = tr_innerHTML
                    tbody.appendChild(tr)
                    if (++i > 20) break;
                }
            }
            
            // INISIASI CANVAS
            {
                const vectorCanvas = document.getElementById("vector-canvas")
                const canvas = new Canvas(vectorCanvas, {
                    width: 300,
                    height: 300,
                    padding: 0
                })
                const selectX = document.getElementById("vector-x")
                const selectY = document.getElementById("vector-y")
                let select_innerHTML = ""
                Vectorizer.vocabulary.forEach((term, index) => {
                    select_innerHTML += `<option value="${index}">${term}</option>`
                })
                selectX.innerHTML = selectY.innerHTML = select_innerHTML
                const redrawCanvas = (axisX, axisY) => {
                    canvas.clear()
                    canvas.drawPoints(
                        Data.vectors.map(p => [p[axisX], p[axisY]]),
                        Data.classes.map(c => c == 1 ? "blue" : "red")
                    )
                    canvas.drawAxis()
                }
                selectX.addEventListener("change", e => redrawCanvas(selectX.value, selectY.value))
                selectY.addEventListener("change", e => redrawCanvas(selectX.value, selectY.value))
            }
                    
            // INISIASI VECTORIZER:
            {
                document.getElementById("balsem-geliga")
                    .setAttribute("colspan", `${Vectorizer.vocabulary.length}`)
                const nggatau = document.getElementById("rolled-oat")
                nggatau.innerHTML = ""
                document.getElementById("bakso1").innerHTML = "<th>TF</th>" + "<td></td>".repeat(Vectorizer.vocabulary.length)
                document.getElementById("bakso2").innerHTML = "<th>TF-IDF</th>" + "<td></td>".repeat(Vectorizer.vocabulary.length)
                Vectorizer.vocabulary.forEach(term => {
                    const th = document.createElement("th")
                    th.innerText = `"${term}"`
                    nggatau.appendChild(th)
                })
                document.getElementById("bakso-bakar").addEventListener("click", e => {
                    // yah intinya gitu.
                    const d = new TFIDF_Document(document.getElementById("textarea-vectorizer").value.trim().split(" "))
                    let tf_innerHTML = "<th>TF</th>"
                    let tfidf_innerHTML = "<th>TF-IDF</th>"
                    d.calculateTF(Vectorizer.vocabulary).forEach(tf => {
                        tf_innerHTML += `<td>${tf.toFixed(7)}</td>`
                    })
                    Vectorizer.vectorizeDocument(d).forEach(tfidf => {
                        tfidf_innerHTML += `<td>${tfidf.toFixed(7)}</td>`
                    })
                    document.getElementById("bakso1").innerHTML = tf_innerHTML
                    document.getElementById("bakso2").innerHTML = tfidf_innerHTML
                })
            }
        
            // INISIASI TABEL IDF
            {
                const tableIDF = document.getElementById("table-idf")
                tableIDF.innerHTML = ""
                Vectorizer.vocabulary.forEach((term, index) => {
                    tableIDF.innerHTML += `<tr><th>"${term}"</th><td>${Vectorizer.idf[index].toFixed(7)}</td></tr>`
                })
            }

            // INISIASI BUTTON DOWNLOAD
            {
                document.getElementById("download-dataset-csv").addEventListener("click", event => {
                    // parse dataset menjadi csv
                    let datasetCSV = `${Vectorizer.vocabulary.join(",")},class\n`
                    Data.vectors.forEach((vector, index) => {
                        datasetCSV += `${vector.join(",")},${Data.classes[index]}\n`
                    })
                    downloadTextFile(datasetCSV, "dataset.csv")
                })
                document.getElementById("download-idf-json").addEventListener("click", event => {
                    let idfJSON = {}
                    Vectorizer.vocabulary.forEach((term, index) => {
                        idfJSON[term] = Vectorizer.idf[index]
                    })
                    downloadTextFile(JSON.stringify(idfJSON, null, 2), "idf.json")
                })
            }

        })

    </script>

    <!-- svm -->
    <script src="./modules/svm.js"></script>
    <script>
        /**
         * NOTE:
         * karena semua angka pada train_x berupa bilangan desimal yang sangat kecil, maka operasi
         * komputasi SVM dapat menimbulkan banyak round-off & precision error (riil, udah aku coba).
         * maka dilakukan normalization / scaling kepada semua elemen feature vector X dengan faktor
         * 1024, yaitu 2^10 (dipilih eksponen 2 biar komputer enak ngitungnya)
         * 
         * sehingga bias dan weight yang nanti dihasilkan akan dibagi dengan faktor yang sama
         * (1024) untuk dapat melihat hasil aslinya.
         * 
         * hal tersebut mungkin dilakukan dan hasilnya tetap valid, berikut pembuktiannnya:
         * SVM's decision function:
         *  f(x) = sign(w.x + b)
         *       = sign((1024*w).(1024*x) + (1024*b))
         * data di scale: x_scaled <-- 1024 * x
         *       = sign(w'.x_scaled + b')
         * penggunaan decision function untuk data yang tidak di scale:
         *       = sign((w'/1024).(x_scaled/1024) + (b'/1024))
         *       = sign((w'/1024).x + (b'/1024))
         * terbukti weight dan bias cukup di scale down dengan faktor yang sama, dan
         * SVM masih bekerja.
        */
        const scale = 1024
        let svm = null
        let canvas = null
        document.addEventListener("documentsHasBeenVectorized", event => {
            
            // INISIASI SVM
            Data.scaledVectors = Data.vectors.map(vec => vec.map(ele => ele * scale))
            svm = new SVM(Data.scaledVectors, Data.classes)

            // INISIASI CANVAS SVM
            {
                const svmCanvas = document.getElementById("svm-canvas")
                canvas = new Canvas(svmCanvas, {
                    width: 500,
                    height: 500,
                    padding: 20
                })
                const selectX = document.getElementById("svm-x")
                const selectY = document.getElementById("svm-y")
                let select_innerHTML = ""
                Vectorizer.vocabulary.forEach((term, index) => {
                    select_innerHTML += `<option value="${index}">${term}</option>`
                })
                selectX.innerHTML = selectY.innerHTML = select_innerHTML
                const redrawCanvas = (axisX, axisY) => {
                    canvas.clear()
                    canvas.drawPoints(
                        Data.scaledVectors.map(p => [p[axisX], p[axisY]]),
                        Data.classes.map(c => c == 1 ? "blue" : "red")
                    )
                    const w = svm.getWeight()
                    console.log([w[axisX], w[axisY]])
                    canvas.drawLine([w[axisX], w[axisY]], svm.getBias())
                    canvas.drawAxis()
                }
                selectX.addEventListener("change", e => redrawCanvas(selectX.value, selectY.value))
                selectY.addEventListener("change", e => redrawCanvas(selectX.value, selectY.value))
                document.getElementById("optimize-smo").addEventListener("click", event => {
                    svm.iterate()
                    redrawCanvas(selectX.value, selectY.value)
                })
            }


        })    
    </script>
</body>
</html>